# Contributor: Adam Nye <adam@spoontech.biz>
# Maintainer: Adam Nye <adam@spoontech.biz>
pkgname=virtualbox
pkgver=5.1.22
pkgrel=0
pkgdesc="A powerful x86 and AMD64/Intel64 virtualization product for enterprise as well as home use"
url="https://www.virtualbox.org"
arch="all"
license="GPL2"
depends=""
makedepends="sed iasl gcc libxml2-dev curl-dev libvpx-dev libpng-dev libx11-dev libxext-dev libxcursor-dev libxinerama-dev libxrandr-dev libxmu-dev mesa-dev glu-dev qt5-qtbase-dev python3-dev alsa-lib-dev lvm2-dev libcap-dev kbuild yasm"
install=""
subpackages="$pkgname-doc"
source="http://download.virtualbox.org/$pkgname/$pkgver/VirtualBox-$pkgver.tar.bz2
	futimens.patch
	musl-fix-headers.patch
	musl-no-glibc.patch
	musl-fix-stat-nsec.patch
	musl-sched_yield.patch
	uclibc-gnu_linux.patch
	virtualbox-localconfig
	"
builddir="$srcdir/VirtualBox-$pkgver"

prepare() {
	cd "VirtualBox-$pkgver"
	rm -rf VirtualBox-$pkgver/kBuild/bin VirtualBox-$pkgver/tools
	local i
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
	cp $srcdir/$pkgname-localconfig LocalConfig.kmk
}

build() {
	cd "$builddir"
	read -p "we will pause here"
	CPLUS_INCLUDE_PATH=$CPLUS_INCLUDE_PATH:/usr/include/libxml2/
	./configure --disable-sdl --disable-pulse --disable-opengl --with-linux=/usr --nofatal
	source ./env.sh
	kmk KBUILD_VERBOSE=2 all
	read -p "we will pause here again"
}

package() {
	cd "$builddir"/out/linux.amd64/release/bin/src
	make
	make install
#	install -v -dm755 "$pkgdir/usr/bin"
##	install -v -m755 VBox.sh "$pkgdir/usr/bin/VBox"
#	echo "2"
#	for i in VBoxHeadless VBoxManage VBoxSDL VirtualBox vboxwebsrv VBoxBalloonCtrl; do
#		ln -sf VBox "$pkgdir/usr/bin/$i"
##		ln -sf VBox "$pkgdir/usr/bin/${i,,}"
#	done
#	echo "3"
#	install -v -dm755 "$pkgdir/usr/lib/virtualbox"
#	install -v -m755 *.so "$pkgdir/usr/lib/virtualbox"
#	install -v -m644 *.rc *.r0 VBoxEFI*.fd "$pkgdir/usr/lib/virtualbox"
#	## setuid root binaries
#	echo "4"
#	install -v -m4755 VBoxSDL VirtualBox VBoxHeadless VBoxNetDHCP VBoxNetAdpCtl VBoxNetNAT -t "$pkgdir/usr/lib/virtualbox"
#	
#	## components
#	install -v -dm755 "$pkgdir/usr/lib/virtualbox/components"
#	install -v -m755 components/* -t "$pkgdir/usr/lib/virtualbox/components"
#
#	## other binaries
##	install -v -m755 VBoxManage VBoxSVC VBoxExtPackHelperApp VBoxXPCOMIPCD VBoxTestOGL VBoxBalloonCtrl vboxwebsrv webtest -t "$pkgdir/usr/lib/virtualbox"
#	install -v -Dm755 "$builddir"/out/linux.*/release/bin/additions/VBoxService "$pkgdir/usr/sbin/VBoxService"
#	install -v -Dm755 "$builddir"/out/linux.*/release/bin/additions/VBoxControl "$pkgdir/usr/bin/VBoxControl"
#	install -v -Dm755 "$builddir"/out/linux.*/release/bin/additions/mount.vboxsf "$pkgdir/usr/sbin/mount.vboxsf"
#	install -v -Dm644 "$builddir"/COPYING "$pkgdir/usr/share/licenses/$pkgname/COPYING"
#
##	# icons
#	install -v -Dm644 VBox.png "$pkgdir/usr/share/pixmaps/VBox.png"
#	pushd icons >/dev/null
#	for i in *; do
#		install -d "$pkgdir/usr/share/icons/hicolor/$i/mimetypes"
#		cp $i/* "$pkgdir/usr/share/icons/hicolor/$i/mimetypes"
#	done
#	popd >/dev/null
#
#	#install configuration
#	install -dm755 "$pkgdir/etc/vbox"
#	echo 'INSTALL_DIR=/usr/lib/virtualbox' > "$pkgdir/etc/vbox/vbox.cfg"

}

sha512sums="e48457371c9139fc04477c82fbd18974378fde08af2a6f9058a0eafa6e522987bd129b8d87c9f381789c4e817aded752fde6ea7fcb2ade471997373802e09348  VirtualBox-5.1.22.tar.bz2
1da850bc30399ecde501eba5403ef1add1ae108d38394b01cd7f5cdf0462b855793d564d3adc1f770983b36529d77f3f7b0269fb65152468084a0a44c38e1638  futimens.patch
0169a620d62aa3de8124e0084f4b747b602fbdcab7892fe075606459e0200d412321c86da4c5d98309f4d7479ae1b5267ed28bea6c6e64fd8be88cab74f8e94c  musl-fix-headers.patch
b1c47cb910ac751df7bd4bc10c5501e91d88a9b3e4fe181b02755d433df8e89a160a38422912266f0cc51ba0c09854dad513ba6f2634fc76c59cee7989b259eb  musl-no-glibc.patch
2c329085915f0ffa43828a14d8b29d0d876e48e18a0190ad146cd0731af7eca11cdf41d2e533c9cc73aa75506b9b91e3a08f2272cd8884e0d929722730b99862  musl-fix-stat-nsec.patch
56c5c3a0becd8f1886010f5f231aa1d2e129bf188f8220e111fb9d51c191a429940edec700f5286b46dadbb45b62e67ee4e09fec6bcea61a344fb65afcbd6756  musl-sched_yield.patch
d2bba9de80c40bc258b025a8e3395a4b0b7781d70d5528993f0fff57e9fc015306b483d4da14e22aed3f188ffda8685aa51e13943f48c17ae18a2a66d15d7bbb  uclibc-gnu_linux.patch
fcfef127ed798ec599386fed26e75d83b7c9c43f09b6b4d9e1b2cc069d6717ca4dad702d6cda09b353fa511b591a9680d14c717d4ead20f443075dfcd351870c  virtualbox-localconfig"
